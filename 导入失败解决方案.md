# 导入失败解决方案

## 🎯 当前问题
**导入完成！成功 0 条，失败 5 条**

## 🔍 问题分析

导致所有导入失败的常见原因：

1. **学生数据不存在** - 系统中没有对应的学号
2. **导入函数缺失** - 数据库中缺少必要的存储过程
3. **RLS策略阻止** - 行级安全策略禁止插入操作
4. **数据格式问题** - Excel解析后的数据格式不正确
5. **权限不足** - 用户没有写入毕业去向表的权限

## 🚀 快速解决方案

### 步骤1: 执行数据库修复
```bash
# 在PostgreSQL中执行修复脚本
psql -d your_database -f quick_import_fix.sql
```

这个脚本会：
- ✅ 创建测试学生数据（5条）
- ✅ 更新导入函数，简化验证逻辑
- ✅ 临时禁用RLS策略
- ✅ 清理旧的失败记录

### 步骤2: 验证修复效果
```sql
-- 检查学生数据
SELECT student_number, full_name, class_name FROM student_profiles LIMIT 5;

-- 测试导入函数
SELECT simple_import_graduation_data('2021001', 'employment', '阿里巴巴', '前端开发', 15000, '杭州');
```

### 步骤3: 重新测试导入
1. 重启应用
2. 进入毕业去向管理
3. 使用以下测试数据：

| 学号 | 去向类型 | 单位名称 | 职位 | 薪资 | 工作地点 |
|------|----------|----------|------|------|----------|
| 2021001 | employment | 阿里巴巴 | 前端开发工程师 | 15000 | 杭州 |
| 2021002 | furtherstudy | | | | 清华大学 | 计算机应用技术 | 硕士研究生 |
| 2021003 | employment | 腾讯 | 后端开发工程师 | 18000 | 深圳 |

## 🔧 详细修复步骤

### 如果问题持续存在，按顺序执行：

#### 1. 检查学生数据
```sql
-- 查看系统中的学生
SELECT COUNT(*) as student_count FROM student_profiles;
SELECT student_number, full_name FROM student_profiles LIMIT 10;
```

如果没有学生数据，先插入：
```sql
INSERT INTO student_profiles (id, user_id, student_number, full_name, class_name, admission_date, graduation_date, created_at, updated_at)
VALUES 
(gen_random_uuid(), gen_random_uuid(), '2021001', '张三', '计算机科学与技术1班', '2021-09-01', '2025-06-30', NOW(), NOW());
```

#### 2. 检查表结构
```sql
-- 确保表存在且结构正确
\d graduation_destinations
\d graduation_import_batches
\d graduation_import_failures
```

#### 3. 检查RLS策略
```sql
-- 查看RLS策略
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE tablename IN ('graduation_destinations', 'student_profiles');

-- 临时禁用RLS
ALTER TABLE graduation_destinations DISABLE ROW LEVEL SECURITY;
```

#### 4. 检查用户权限
```sql
-- 查看用户权限
SELECT grantee, table_name, privilege_type 
FROM information_schema.role_table_grants 
WHERE table_name = 'graduation_destinations';
```

## 📊 常见错误对照表

| 错误信息 | 原因 | 解决方案 |
|----------|------|----------|
| 找不到学号为XXX的学生 | 学生不存在 | 先导入学生数据 |
| 无效的去向类型 | 类型值错误 | 使用正确的类型值 |
| permission denied | 权限不足 | 检查用户权限 |
| relation does not exist | 表不存在 | 创建相关表 |
| RLS violation | 安全策略阻止 | 禁用或修改RLS策略 |

## 🎯 验证成功标准

修复成功的标志：
- ✅ 执行数据库脚本无错误
- ✅ 测试数据能够导入
- ✅ 导入批次显示成功计数 > 0
- ✅ 毕业去向表中出现新记录
- ✅ 浏览器控制台无错误

## 🚨 如果仍然失败

按顺序执行以下完整修复：

```bash
# 1. 完全重建表
\i fix_graduation_import_function.sql

# 2. 快速修复约束和权限
\i fix_database_constraints.sql

# 3. 简化导入流程
\i quick_import_fix.sql

# 4. 验证所有表和函数
SELECT 'student_profiles表: ' || COUNT(*) || ' 条' FROM student_profiles;
SELECT '导入函数状态: ' || proname FROM pg_proc WHERE proname = 'simple_import_graduation_data';
```

## 💡 预防措施

1. **数据准备**：确保学号和去向类型正确
2. **定期维护**：定期检查数据库完整性
3. **错误监控**：查看控制台和数据库日志
4. **测试验证**：小批量测试后再大批量导入

---

## 🎉 期望结果

执行修复后，导入应该显示：
**导入完成！成功 3 条，失败 0 条**

如果达到这个结果，说明导入功能已完全修复！