# 毕业导入失败解决方案

## 问题描述
毕业去向批量导入时显示：**"导入完成！成功 0 条，失败 5 条，请查看导入历史了解详细错误信息"**

## 问题分析
1. ✅ "user is not defined" 错误已修复
2. ❌ 导入失败的原因：数据库中缺少 `simple_import_graduation_data` 存储过程

## 解决方案

### 方案一：执行SQL脚本（推荐）

在您的 Supabase 项目中执行以下SQL脚本：

1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 执行 `create_simple_import_function.sql` 文件中的内容

这个脚本会创建：
- `simple_import_graduation_data()` - 单条数据导入函数
- `create_import_batch()` - 创建批次函数
- `record_import_failure()` - 记录失败信息函数
- `update_batch_status()` - 更新批次状态函数

### 方案二：手动检查数据库

如果方案一不生效，需要检查：

1. **检查表是否存在：**
```sql
SELECT * FROM information_schema.tables 
WHERE table_name IN ('graduation_destinations', 'graduation_import_batches', 'graduation_import_failures');
```

2. **检查学生数据是否存在：**
```sql
SELECT COUNT(*) as student_count FROM student_profiles;
SELECT student_number, full_name FROM student_profiles LIMIT 5;
```

3. **检查权限设置：**
```sql
-- 确保RLS策略允许插入操作
ALTER TABLE graduation_destinations DISABLE ROW LEVEL SECURITY;
ALTER TABLE graduation_import_batches DISABLE ROW LEVEL SECURITY;
ALTER TABLE graduation_import_failures DISABLE ROW LEVEL SECURITY;
```

## 常见错误及解决方法

### 1. "找不到学号为 X 的学生"
**原因：** 数据库中没有对应的学生记录
**解决：** 先导入学生数据，或在学生管理中添加学生

### 2. "无效的去向类型"
**原因：** 去向类型值不正确
**解决：** 使用以下有效值之一：
- `employment` - 就业
- `furtherstudy` - 国内升学  
- `abroad` - 出国留学
- `entrepreneurship` - 创业
- `unemployed` - 待业
- `other` - 其他

### 3. "数据库错误: relation does not exist"
**原因：** 相关表不存在
**解决：** 执行完整的数据库初始化脚本

## 测试步骤

解决后，请按以下步骤测试：

1. **准备测试数据：**
   - 确保学生表中存在测试学号
   - 使用正确的去向类型

2. **执行导入测试：**
   - 下载最新的Excel模板
   - 填写测试数据（2-3条即可）
   - 执行批量导入

3. **验证结果：**
   - 检查是否显示成功记录
   - 查看导入历史中的详细信息
   - 确认数据出现在毕业去向列表中

## 紧急修复

如果上述方法都不奏效，可以使用临时方案：

1. 使用 SQL Editor 直接插入数据：
```sql
INSERT INTO graduation_destinations (
    student_id,
    destination_type,
    company_name,
    position,
    status,
    submit_time
) VALUES (
    (SELECT id FROM student_profiles WHERE student_number = '2021001'),
    'employment',
    '腾讯科技有限公司',
    '软件工程师',
    'pending',
    NOW()
);
```

2. 联系技术支持执行数据库修复

## 联系支持

如果问题持续存在，请提供以下信息：
- 错误信息的完整截图
- 导入的Excel文件内容
- 数据库中的学生数据状况
- 已执行的SQL脚本