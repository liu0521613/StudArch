# 奖惩数据库设置指南

## 前置条件

1. ✅ 您已拥有Supabase项目和数据库
2. ✅ 前端项目已配置Supabase连接
3. ✅ 基础学生表已存在

## 设置步骤

### 第一步：在Supabase控制台中执行SQL

1. **登录Supabase控制台**
   - 访问 https://supabase.com
   - 登录您的账户
   - 选择对应的项目

2. **打开SQL编辑器**
   - 在左侧菜单中找到 "SQL Editor"
   - 点击 "New query" 创建新的查询

3. **执行建表脚本**
   - 复制 `create_reward_punishment_tables.sql` 文件中的全部内容
   - 粘贴到SQL编辑器中
   - 点击 "RUN" 执行脚本

4. **验证表创建**
   执行以下SQL验证表是否创建成功：
   ```sql
   SELECT table_name, table_type 
   FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name IN ('reward_punishments', 'reward_punishment_attachments')
   ORDER BY table_name;
   ```

### 第二步：测试数据库连接

1. **运行测试脚本**
   ```bash
   cd d:/lyc123/poject/download-APP_GENERATION/app_567616553474
   node test_simple_reward_api.cjs
   ```

2. **检查测试结果**
   - ✅ 看到 "数据库连接成功" 表示设置正确
   - ❌ 如果看到错误，请检查配置和表创建状态

### 第三步：启动前端应用

1. **启动开发服务器**
   ```bash
   npm run dev
   ```

2. **访问奖惩管理页面**
   - 登录教师账号
   - 进入"我的学生"
   - 点击任意学生的"查看档案"
   - 切换到"奖惩信息"标签页

## 完整的SQL脚本

如果您无法直接执行SQL文件，请手动执行以下内容：

```sql
-- 创建奖惩信息表
CREATE TABLE IF NOT EXISTS reward_punishments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id UUID NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('reward', 'punishment')),
    name TEXT NOT NULL,
    level TEXT NOT NULL CHECK (level IN ('class', 'department', 'school', 'province', 'country')),
    category TEXT,
    description TEXT NOT NULL,
    date DATE NOT NULL,
    created_by TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    reviewed_by TEXT,
    reviewed_at TIMESTAMP WITH TIME ZONE,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    review_notes TEXT
);

-- 创建奖惩附件表
CREATE TABLE IF NOT EXISTS reward_punishment_attachments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reward_punishment_id UUID NOT NULL REFERENCES reward_punishments(id) ON DELETE CASCADE,
    file_name TEXT NOT NULL,
    file_path TEXT NOT NULL,
    file_type TEXT NOT NULL,
    file_size NUMERIC,
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_reward_punishments_student_id ON reward_punishments(student_id);
CREATE INDEX IF NOT EXISTS idx_reward_punishments_type ON reward_punishments(type);
CREATE INDEX IF NOT EXISTS idx_reward_punishments_level ON reward_punishments(level);
CREATE INDEX IF NOT EXISTS idx_reward_punishments_status ON reward_punishments(status);
CREATE INDEX IF NOT EXISTS idx_reward_punishments_date ON reward_punishments(date DESC);

-- 禁用RLS策略
ALTER TABLE reward_punishments DISABLE ROW LEVEL SECURITY;
ALTER TABLE reward_punishment_attachments DISABLE ROW LEVEL SECURITY;

-- 插入示例数据（如果表为空）
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM reward_punishments LIMIT 1) THEN
        -- 获取现有学生的ID
        DECLARE
            student_uuid UUID;
        BEGIN
            SELECT id INTO student_uuid FROM student_profiles LIMIT 1;
            
            IF student_uuid IS NOT NULL THEN
                INSERT INTO reward_punishments (
                    student_id, type, name, level, category, description, date, created_by, status
                ) VALUES 
                (
                    student_uuid, 
                    'reward', 
                    '校级奖学金', 
                    'school', 
                    '奖学金', 
                    '获得2021-2022学年校级一等奖学金', 
                    '2022-10-15', 
                    'teacher001',
                    'approved'
                ),
                (
                    student_uuid, 
                    'reward', 
                    '优秀学生干部', 
                    'school', 
                    '荣誉', 
                    '被评为2022年度优秀学生干部', 
                    '2023-03-20', 
                    'teacher001',
                    'approved'
                ),
                (
                    student_uuid, 
                    'punishment', 
                    '迟到警告', 
                    'class', 
                    '纪律处分', 
                    '因多次上课迟到，给予口头警告', 
                    '2022-12-05', 
                    'teacher001',
                    'approved'
                );
                
                RAISE NOTICE '已创建3条示例奖惩记录';
            END IF;
        END;
    END IF;
END $$;

-- 验证表创建
SELECT 'reward_punishments 表记录数: ' || COUNT(*) as count FROM reward_punishments;
```

## 环境变量配置

确保您的 `.env` 文件包含以下配置：

```env
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## 故障排除

### 常见问题

1. **表不存在错误**
   - 确保已执行SQL脚本
   - 检查表名拼写是否正确

2. **连接失败错误**
   - 检查Supabase URL和密钥是否正确
   - 确保网络连接正常

3. **权限错误**
   - 确保表已禁用RLS策略
   - 检查API密钥权限

4. **外键约束错误**
   - 确保student_profiles表中有数据
   - 检查student_id是否有效

### 调试步骤

1. **检查数据库连接**
   ```sql
   SELECT current_database(), current_user, current_schema();
   ```

2. **查看表结构**
   ```sql
   \d reward_punishments
   ```

3. **查看现有数据**
   ```sql
   SELECT * FROM reward_punishments LIMIT 5;
   ```

## 功能验证

数据库设置完成后，您应该能够：

1. ✅ **查看奖惩列表**
   - 在学生详情页面查看现有奖惩记录
   - 看到示例数据（如果已创建）

2. ✅ **新增奖惩记录**
   - 点击"新增奖惩"按钮
   - 填写表单并保存
   - 新记录应出现在列表中

3. ✅ **编辑奖惩记录**
   - 点击记录的编辑按钮
   - 修改信息并保存
   - 记录应更新

4. ✅ **删除奖惩记录**
   - 点击记录的删除按钮
   - 确认删除操作
   - 记录应从列表中移除

5. ✅ **筛选功能**
   - 使用类型、级别、状态筛选
   - 列表应相应更新

## 支持与帮助

如果遇到问题：

1. 查看浏览器控制台错误信息
2. 检查网络请求是否正常
3. 确认数据库表结构正确
4. 验证环境变量配置

设置完成后，奖惩信息管理功能将完全可用！