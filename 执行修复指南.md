# 数据库修复执行指南

## 🚨 重要提示
**请使用 `ultra_safe_fix.sql` 文件而不是之前的文件！**

## 问题说明
之前修复脚本中的错误：
- ❌ `users` 表中尝试插入不存在的 `role` 列
- ❌ 可能存在其他表结构冲突

## ✅ 正确的修复步骤

### 1. 打开 Supabase Dashboard
1. 访问：https://supabase.com/dashboard
2. 登录你的账户
3. 选择项目：`mddpbyibesqewcktlqle`

### 2. 执行 SQL 修复脚本
1. 在左侧菜单中找到 **"SQL Editor"**
2. 点击 **"New query"** 创建新的查询
3. 复制 `ultra_safe_fix.sql` 文件的**全部内容**
4. 粘贴到 SQL Editor 中
5. 点击 **"Run"** 执行脚本

### 3. 验证执行结果
执行成功后应该看到类似输出：
```
=== 修复完成验证 ===
users 表记录数: 1
student_profiles 表记录数: 5
graduation_destinations 表记录数: 0

=== 测试导入函数 ===
test_result
SUCCESS: 导入学生 2021001 (张三) 的毕业去向成功

=== 最终验证 ===
graduation_destination_count
1
```

## 📋 脚本功能说明

`ultra_safe_fix.sql` 会完成以下操作：

1. **重建 users 表**（移除 role 列）
2. **确保 student_profiles 表存在并插入测试数据**
3. **重建 graduation_destinations 表**（无外键约束）
4. **重建导入相关表**（graduation_import_batches, graduation_import_failures）
5. **创建必要的触发器函数**
6. **禁用 RLS 策略**
7. **创建简化的导入函数**
8. **执行测试验证**

## 🔧 如果执行失败

### 常见错误及解决：

**错误：`relation "xxx" does not exist`**
- 这是正常的，脚本使用了 `DROP TABLE IF EXISTS` 来重建表

**错误：`permission denied`**
- 确保你使用的是 service role key 或有足够权限的账户

**错误：`column "xxx" does not exist`**
- 这个新脚本已经修复了所有列名问题

## 🎯 修复完成后的操作

1. **重新启动应用**
   ```bash
   npm run dev
   ```

2. **测试导入功能**
   - 进入教师毕业去向管理页面
   - 点击 "批量导入"
   - 上传 Excel 文件
   - 确认导入成功

3. **验证用户认证**
   - 现在应该不会再出现 "user is not defined" 错误
   - 控制台会显示用户ID获取日志

## 📞 如果仍有问题

1. **检查 SQL 执行日志**
   - 查看 Supabase Dashboard 的执行结果
   - 确认没有红色错误信息

2. **检查浏览器控制台**
   - 查看网络请求是否正常
   - 确认用户ID获取日志

3. **重新执行脚本**
   - 删除现有表（脚本会自动处理）
   - 重新执行一遍 `ultra_safe_fix.sql`

## ✨ 预期结果

修复完成后：
- ✅ 数据库表结构正确
- ✅ 测试学生数据可用
- ✅ 导入功能正常工作
- ✅ 用户认证问题解决
- ✅ 不再出现 "user is not defined" 错误

---

**请务必使用 `ultra_safe_fix.sql` 文件！**