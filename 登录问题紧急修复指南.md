# 登录问题紧急修复指南

## 问题描述
登录时出现错误：**"查询用户失败: Could not find a relationship between 'users' and 'roles' in the schema cache"**

## 问题原因
之前执行的 `simple_fix_final.sql` 脚本创建了一个简化的用户表，缺少：
- `roles` 表
- `role_id` 字段和引用关系
- 完整的用户认证字段

## 🚨 紧急修复步骤

### 第一步：执行修复脚本
1. **登录 Supabase Dashboard**
2. **进入 SQL Editor**
3. **执行** `fix_login_tables.sql` 文件的全部内容
4. **等待执行完成**（约30-60秒）

### 第二步：验证修复结果
执行以下SQL确认修复成功：

```sql
-- 检查角色表
SELECT * FROM roles;

-- 检查用户表（应该有role_id字段）
SELECT id, username, email, user_number, full_name, role_id FROM users;

-- 检查学生数据
SELECT student_number, full_name, class_name FROM student_profiles LIMIT 5;
```

### 第三步：测试登录
使用以下测试账号登录：

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| teacher | 123456 | 教师 | 主要测试账号 |
| admin | 123456 | 超级管理员 | 管理员账号 |
| student1 | 123456 | 学生 | 学生测试账号 |

## 修复内容详解

### 1. 重建角色表
```sql
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    role_name VARCHAR(50) NOT NULL UNIQUE,
    role_description TEXT,
    permissions JSONB DEFAULT '[]',
    -- ...
);
```

### 2. 重建完整的用户表
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) UNIQUE,
    user_number VARCHAR(50) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role_id INTEGER NOT NULL REFERENCES roles(id), -- 关键修复点
    status VARCHAR(20) DEFAULT 'active',
    -- ...
);
```

### 3. 插入基础数据
- 角色：super_admin, teacher, student
- 测试用户：teacher, admin, student1, student2
- 学生档案：5个测试学生

## 常见问题

### Q: 执行SQL脚本失败怎么办？
A: 
- 检查是否有足够的DDL权限
- 分段执行SQL语句
- 确认Supabase连接正常

### Q: 登录还是失败？
A: 
- 确认已执行完整的修复脚本
- 检查浏览器控制台的具体错误信息
- 清除浏览器缓存重试

### Q: 数据丢失了怎么办？
A: 
- 修复脚本会重建表结构
- 建议先备份现有数据
- 测试数据会自动重新插入

## 验证清单

修复完成后，请确认：

- [ ] 执行 `fix_login_tables.sql` 成功
- [ ] roles 表有3条记录（super_admin, teacher, student）
- [ ] users 表有用户记录且包含 role_id 字段
- [ ] 能够使用 teacher/123456 登录
- [ ] 登录后能够正常访问毕业去向管理页面
- [ ] 批量导入功能正常工作

## 联系支持

如果按照以上步骤操作后问题仍然存在，请提供：
1. Supabase SQL 执行日志
2. 浏览器控制台完整错误信息
3. 执行验证SQL的结果截图

## 备份建议
在执行修复脚本前，如果重要数据请先：
1. 备份现有表：`CREATE TABLE users_backup AS SELECT * FROM users;`
2. 记录关键数据：导出用户和角色数据
3. 保存测试账号信息

---

⚠️ **重要提醒**：执行修复脚本会重建用户相关表，请确保已备份重要数据！