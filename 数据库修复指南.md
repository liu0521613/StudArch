# 数据库修复指南

## 问题说明
错误：`Error: Failed to run sql query: ERROR: 42P01: relation "graduation_destinations" does not exist`

这表示数据库中缺少 `graduation_destinations` 表，导致毕业去向导入功能无法正常工作。

## 解决方案

### 方法一：通过 Supabase Dashboard 手动执行（推荐）

1. **打开 Supabase Dashboard**
   - 访问：https://supabase.com/dashboard
   - 登录你的账户
   - 选择项目：`mddpbyibesqewcktlqle`

2. **打开 SQL Editor**
   - 在左侧菜单中找到 "SQL Editor"
   - 点击 "New query"

3. **执行修复脚本**
   - 复制 `complete_database_fix.sql` 文件中的全部内容
   - 粘贴到 SQL Editor 中
   - 点击 "Run" 执行

4. **验证执行结果**
   - 查看执行结果中的验证信息
   - 确认所有表都已创建成功

### 方法二：使用自动执行脚本

如果你有 Node.js 环境，可以运行：

```bash
cd "d:/lyc123/poject/download-APP_GENERATION/app_567616553474"
node execute_sql.js
```

## 修复内容

该脚本将创建以下数据库表和功能：

1. **基础表**
   - `users` - 用户表
   - `student_profiles` - 学生档案表
   - `graduation_destinations` - 毕业去向表 ⭐（关键表）
   - `graduation_import_batches` - 导入批次表
   - `graduation_import_failures` - 导入失败记录表

2. **导入函数**
   - `simple_import_graduation_data` - 简化的单条记录导入函数
   - `create_import_batch` - 创建导入批次函数

3. **测试数据**
   - 自动插入5个测试学生记录
   - 执行测试导入验证功能

4. **配置**
   - 禁用 RLS 策略（临时）
   - 创建时间戳更新触发器

## 执行后验证

执行完成后，你应该看到类似以下的结果：

```
=== 修复结果验证 ===
users 表记录数: 0
student_profiles 表记录数: 5
graduation_destinations 表记录数: 0
graduation_import_batches 表记录数: 0

=== 测试导入函数 ===
test_result
SUCCESS: 导入学生 2021001 (张三) 的毕业去向成功

=== 最终验证 ===
graduation_destination_count
1
```

## 修复后的操作

1. **重新启动应用**
   ```bash
   npm run dev
   ```

2. **测试批量导入功能**
   - 进入教师毕业去向管理页面
   - 尝试批量导入 Excel 文件
   - 确认导入功能正常工作

## 常见问题

**Q: 执行 SQL 时出现权限错误**
A: 确保你使用的是 service role key 或有足够权限的账户登录 Supabase Dashboard

**Q: 表已存在错误**
A: 脚本使用了 `IF NOT EXISTS`，应该不会出现此问题。如果仍有问题，可以先删除现有表再重新创建

**Q: 导入仍然失败**
A: 检查应用中的环境变量配置是否正确，确保连接到正确的 Supabase 项目

## 技术支持

如果修复过程中遇到问题，请检查：
1. Supabase 项目 URL 和密钥是否正确
2. 网络连接是否正常
3. SQL 脚本是否完整复制

修复完成后，毕业去向批量导入功能应该可以正常使用了。